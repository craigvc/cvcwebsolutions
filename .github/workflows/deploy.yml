name: Deploy to Production

on:
  push:
    branches:
      - master  # Triggers on push to master branch
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: 22
          script: |
            cd /home/ploi/cvcwebsolutions

            # Pull latest changes
            echo "üì• Pulling latest code from GitHub..."
            git pull origin master

            # Create .env.production if it doesn't exist (from example)
            if [ ! -f .env.production ]; then
              echo "‚öôÔ∏è  Creating .env.production from example..."
              cp .env.production.example .env.production
              echo "‚ö†Ô∏è  WARNING: Please update .env.production with real credentials!"
            fi

            # Stop existing container
            echo "üõë Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down

            # Build and start new container
            echo "üî® Building new Docker image..."
            docker-compose -f docker-compose.prod.yml build --no-cache

            echo "üöÄ Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d

            # Clean up old images
            echo "üßπ Cleaning up old Docker images..."
            docker image prune -f

            # Show status
            echo "‚úÖ Deployment complete!"
            docker-compose -f docker-compose.prod.yml ps

            # Show recent logs
            echo "üìã Recent logs:"
            docker-compose -f docker-compose.prod.yml logs --tail=20

      - name: Deployment notification
        if: success()
        run: |
          echo "‚úÖ Successfully deployed to production!"
          echo "üåê Site: https://cvcwebsolutions.com"

      - name: Deployment failed
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above."
